---
- name: Ensure the unzip package is installed
  package:
    name: unzip
    state: present
  become: True

- name: Retrieve the GPU firmware image from Dell downloads site
  unarchive:
    src: "{{ dell_gpu_url }}"
    remote_src: yes
    mode: 0755
    dest: "/tmp/"

# Joe's tip on modules to unload first (in this order)
- name: Unload Nvidia kernel modules
  command: "rmmod {{item}}"
  become: True
  with_items:
  - "nv_peer_mem"
  - "gdrdrv"
  - "nvidia_uvm"
  - "nvidia_drm"
  - "nvidia_modeset"
  - "nvidia"

# FIXME: use of magic name here
- name: Execute the GPU firwmare update from the zipfile
  command: "/tmp/P100_PCN204260.bin -q"
  become: True

- name: Remove the update files
  file:
    path: "/tmp/P100_PCN204260.bin"
    state: absent
